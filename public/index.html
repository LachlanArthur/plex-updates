<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<link rel="icon" href="./favicon.ico" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" type="text/css" href="./index.css" />
	<title>Plex Updates</title>
</head>

<body>
	<noscript>You gotta have JavaScript for this.</noscript>

	<form id="plexUpdates" action="#" x-data="PlexUpdates.alpine()" x-init="init">

		<label for="imgurClientId">Imgur Client ID</label>
		<input type="text" id="imgurClientId" autocomplete="imgur-client-id" x-model="imgurClientId" />
		<br>
		<label for="plexUrl">Plex URL (local network IP including port)</label>
		<input type="url" id="plexUrl" autocomplete="plex-url" x-model="plexUrl" />
		<br>
		<label for="plexToken">Plex Token</label>
		<input type="text" id="plexToken" autocomplete="plex-token" x-model="plexToken" />
		<br>
		<button type="button" @click="onclick_connectToServer">Connect to server</button>

		<template x-if="server">
			<div>

				<h3>Connected to <span x-text="server.name"></span></h3>

				<label>Plex Libraries</label>
				<ul>
					<template x-for="section in librarySections" :key="section.key">
						<li>
							<label>
								<input type="checkbox" x-model="selectedLibrarySectionsKeys" :value="section.key" />
								<span x-text="section.title"></span>
							</label>
						</li>
					</template>
				</ul>

				<br>
				<button type="button" @click="onclick_getRecentlyAdded">Get recently added items from <span x-text="selectedLibrarySectionsKeys.length">0</span> sections</button>

				<h3 x-show="recentlyAdded.length">Recently added</h3>

				<ul class="recently-added-media">
					<template x-for="media in recentlyAdded" :key="media.key">
						<li>
							<label>
								<input type="checkbox" x-model="selectedMediaKeys" :value="media.key" />
								<img :src="getMediaPoster( media )" loading="lazy" />
								<div class="media-meta">
									<span class="media-title">
										<strong x-text="getMediaTitle( media )"></strong> (<span x-text="media.year"></span>)
									</span><br>
									<time-ago :datetime="getMediaAddedAtIso(media)"></time-ago>
								</div>
							</label>
						</li>
					</template>
				</ul>

				<template x-if="selectedMediaKeys.length">
					<div>

						<h3>Email setup</h3>

						<label for="jmapHost">JMAP Host</label>
						<input type="url" id="jmapHost" autocomplete="jmap-host" x-model="jmapHost" />
						<br>
						<label for="jmapUsername">JMAP Username</label>
						<input type="text" id="jmapUsername" autocomplete="jmap-username" x-model="jmapUsername" />
						<br>
						<label for="jmapPassword">JMAP Password</label>
						<input type="password" id="jmapPassword" autocomplete="jmap-password" x-model="jmapPassword" />
						<br>
						<button type="button" @click="onclick_connectToJmap">Connect to JMAP</button>

						<template x-if="jmapDraftMailboxId">
							<div>

								<p>Connected to JMAP</p>

								<h3>Contacts</h3>
								<table width="400">
									<colgroup>
										<col>
										<col>
										<col width="1%">
									</colgroup>
									<thead>
										<tr>
											<th>Active</th>
											<th>Name</th>
											<th>Email</th>
											<th>&nbsp;</th>
										</tr>
									</thead>
									<tbody>
										<template x-for="(contact, index) in jmapContacts" :key="index">
											<tr>
												<td>
													<input type="checkbox" x-model="contact.active" @click="trigger_saveContacts" />
												</td>
												<td>
													<input type="text" x-model="contact.name" @keyup="trigger_saveContacts" />
												</td>
												<td>
													<input type="email" x-model="contact.email" @keyup="trigger_saveContacts" />
												</td>
												<td>
													<button type="button" @click="onclick_removeContact(index)">Ã—</button>
												</td>
											</tr>
										</template>
										<tr>
											<td colspan="4">
												<button type="button" @click="onclick_addContact">Add contact</button>
											</td>
										</tr>
									</tbody>
								</table>

								<p>Email from</p>

								<table width="400">
									<tr>
										<th><label for="jmapFromName">Name</label></th>
										<th><label for="jmapFromEmail">Email</label></th>
									</tr>
									<tr>
										<td><input type="text" id="jmapFromName" autocomplete="jmap-from-name" x-model="jmapFromName" /></td>
										<td><input type="email" id="jmapFromEmail" autocomplete="jmap-from-email" x-model="jmapFromEmail" /></td>
									</tr>
								</table>

								<button type="button" :disabled="!jmapContacts.length" @click="onclick_sendUpdate">
									Create draft update emails for <span x-text="activeContacts.length">0</span> contacts
								</button>

								<p x-show="jmapCreateSuccess">Success</p>

							</div>
						</template>

					</div>
				</template>

			</div>
		</template>

	</form>

	<script type="module" src="./index.js"></script>
</body>

</html>
